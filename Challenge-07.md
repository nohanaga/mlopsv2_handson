# Challenge 7 – 再トレーニングとモデル評価

[< Previous Challenge](./Challenge-06.md) - **[Home](./README.md)** - [Next Challenge >](./Challenge-08.md)

## Introduction

新しいデータが継続的にインジェストされてトレーニングパイプラインに投入する仕組みが整いました。ただ、この仕組みでは新しいデータを投入してトレーニングしたとき、モデルの精度が低下するという問題が起きるようになってきました。どうやら最近起きた世界的な医療環境の変化によりデータ自体の分布が変化してしまった可能性があります。

新しいデータが、モデルを学習させたときの元の学習データから乖離すると、モデルの性能は劣化します。モデルドリフトと呼ばれるこの概念は、新しいデータが利用可能になったときに、現在の状態を反映するようにモデルを再トレーニングすることで緩和することができます。

## Description

本チャレンジではシンプルな評価テストとして、新しいモデルと既存のモデルを比較します。新しいモデルの精度が優れている場合にのみ、そのモデルを昇格させます。そうでない場合、そのモデルは Azure Machine Learning モデルレジストリに登録されないようにします。

![MLOps pipeline by microsoft/MLOpsPython](./images/002.png)

これまでのチャレンジにより、モデルのトレーニングプロセスが上図のような自動実行するサイクルとして完成させる準備が整いました。

## Hack
1. モデルを再トレーニングするには、新しいデータでトレーニング スクリプトを実行できるようにします。
    1. [Challenge 4](./Challenge-04.md) の `04_training_pipeline_job.yml` 内でロードしているデータアセットに注目してください。初期モデルは 350 件にレコード数を減らしたデータ `diabetes_data_oh4ml_350records` で学習されました。
    1. 今度はすべてのデータ 442 件を含む、`diabetes_data_oh4ml` データ アセットを入力に指定します。
    1. この大きなデータセットで回帰モデルを構築します。
1. 現行モデルと最新のモデルの精度を比較して、最新のモデルの精度が高くなったときのみモデルレジストリに登録するコードを作成します。
    1. 新たにノートブックを作成します。
    1. パイプラインの `train` で作成した最新モデルの精度メトリクスを `metric.json` から取得します。
    1. 比較対象の既存モデルは、今回は MLFlow の機能を使ってモデル名から取得します（モデルは複数の方法で取得が可能です）。モデルが取得できれば、モデルのタグから精度メトリクス情報を取得できます。例：RMSE の場合は数値が低いほうが精度が高く、R2 の場合は数値が高いほうが精度が高くなります。
    1. MLFlow でモデルが取得できない場合、新規作成として扱います。
    1. 比較に使用する精度メトリクスを選択し、新たに作成したモデルの精度が既存モデルの精度より悪かった場合はモデル登録フラグを立てません。
    1. このコードを `evaluate.py` として書き出します。
1. 機械学習パイプラインの `train` と `register` の間に `evaluate.py` を実行するステップを追加します。

    **Tips:** `register.py` の中に追加してもかまいません。その場合はステップを追加する必要はありません。

1. トレーニングの変更を反映させるため、機械学習パイプラインを再実行します。新しいモデルの評価指標が以前のモデルよりも優れている場合、再トレーニングしたモデルがモデルレジストリに登録されます。
1. 機械学習パイプラインの成果物とアウトプットを確認します。

## 成功基準

- 再トレーニングしたモデル（必要に応じてパフォーマンスを向上させたもの）を作成し、モデルレジストリに登録するかの判断を行うこと。

## 学習リソース
 - [Azure Machine Learning パイプラインとは](https://docs.microsoft.com/azure/machine-learning/concept-ml-pipelines)
 - [Azure Machine Learning CLI でコンポーネントを使用して機械学習パイプラインを作成して実行する](https://docs.microsoft.com/azure/machine-learning/how-to-create-component-pipelines-cli)
 - [リファレンス: CLI (v2) パイプライン ジョブの YAML スキーマ](https://docs.microsoft.com/azure/machine-learning/reference-yaml-job-pipeline)
- [MLOps リファレンス・アーキテクチャ](<https://docs.microsoft.com/azure/architecture/reference-architectures/ai/mlops-python>)

## さらなる学習
Azure Machine Learning には、トレーニングに用いるデータの変化であるデータ ドリフトを監視する機能が搭載されています。これにより、増え続ける新しいデータのコレクションを元のトレーニング データと定期的に比較し、モデルの精度に影響する可能性のあるデータの傾向の変化を特定することができます。

データ ドリフトに関するアラートを設定して、市場の変化によってデータセットのプロファイルが大きく変わった場合にアラートを送信するように設定してください。

- [データセットでデータ ドリフトを検出する](https://docs.microsoft.com/azure/machine-learning/how-to-monitor-datasets)
## おめでとうございます

この Hack のチャレンジは終了しました。コンテンツは継続的に更新しています。今後のフェーズでは、AKS Data Drift に加え、ONNX や mlflow など他の ML プラットフォームも取り込んで、このソリューションを拡張していく予定です。ご期待ください。
